<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fausto Fusetti - FF Musica</title>
  <link href="https://fonts.googleapis.com/css2?family=Arvo:wght@700&amp;family=Montserrat:wght@400;500;600&amp;display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
  <style>
    :root { --primary-color: #069uden; z-index: 9998;transform:translateY(20px) scale(.95);opacity:0;visibility:hidden;transition:all .3s ease-in-out;}
                #chatbot-window-wrapper.open{transform:translateY(0) scale(1);opacity:1;visibility:visible}
                #chatbot-window{position:relative; margin-top: 45px; width:100%;height:100%;background-color:#f9f7f3;border-radius:15px;box-shadow:0 12px 28px rgba(0,0,0,.2);display:flex;flex-direction:column;overflow:hidden;}
                .chatbot-header-logo {width: 90px;height: 90px;border-radius: 50%;border: 3px solid #fff;box-shadow: 0 0 10px rgba(0,0,0,0.3);object-fit: cover;position: absolute;top: 0;left: 50%;transform: translateX(-50%); z-index: 10000;}
                
                /* ========================================================================================= */
                /* ===== MODIFICA #3: POSIZIONE CHAT ALZATA PER MOBILE                             ===== */
                /* ========================================================================================= */
                @media (max-width: 768px) {
                    #chatbot-window-wrapper { bottom: 115px; right: 15px; }
                    #chatbot-bubble { bottom: 25px; right: 15px; }
                }

                .chatbot-header {position: relative; background-color: var(--primary-color); color: #fff; padding: 1rem; padding-top: 55px; text-align: center; flex-shrink: 0;}
                .chatbot-close-btn {position: absolute; top: 10px; right: 15px; font-size: 2.2em; color: white; cursor: pointer; line-height: 1; font-weight: 300;}
                
                .chatbot-messages {
                    flex-grow:1;
                    padding:1rem;
                    overflow-y:auto;
                    display:flex;
                    flex-direction:column;
                    background-image: url('https://github.com/Rickym2025/fausto-fusetti-links/blob/main/sfondo_chat.jpg?raw=true');
                    background-size: cover;
                    background-position: center;
                    background-repeat: no-repeat;
                }
                
                .message{display:flex;align-items:flex-end;margin-bottom:10px;max-width:85%}.message.user{align-self:flex-end}.message.bot{align-self:flex-start}
                .message-avatar{width:30px;height:30px;border-radius:50%;margin-right:10px;flex-shrink:0}
                .message-text{padding:10px 15px;border-radius:18px;line-height:1.4;overflow-wrap: break-word; word-break: break-word;text-align: left;}
                .message.user .message-text{background-color:rgba(238, 242, 245, 0.95);color:#333;border-bottom-right-radius:4px}
                .message.bot .message-text{background-color:rgba(6, 147, 227, 0.9);color:#fff;border-bottom-left-radius:4px}
                .chatbot-input{display:flex;border-top:1px solid #ddd;background-color:#fff;padding:10px;align-items:center;flex-shrink:0}
                .chatbot-input input{flex-grow:1;border:none;padding:10px;font-size:1rem}.chatbot-input input:focus-visible{outline:2px solid var(--primary-color)}
                .chatbot-input button{background:none;border:none;padding:0 10px;cursor:pointer;color:var(--primary-color)}
            </style>
            <div id="chatbot-bubble">
                <svg class="icon-close" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 384 512"><path fill="currentColor" d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/></svg>
            </div>
            <div id="chatbot-window-wrapper">
                <img src="fausto_immagine.jpg" alt="Fausto AI" class="chatbot-header-logo">
                <div id="chatbot-window">
                    <div class="chatbot-header">
                        <div><h3>Fausto AI</h3><small>Assistente Virtuale</small></div>
                        <span class="chatbot-close-btn">&times;</span>
                    </div>
                    <div class="chatbot-messages" id="chatbot-messages"></div>
                    <div class="chatbot-input">
                        <input type="text" id="chatbot-input-field" name="chatbot_message" autocomplete="off" placeholder="Scrivi un messaggio...">
                        <button id="chatbot-send-btn"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z"/></svg></button>
                    </div>
                </div>
            </div>`;
            
            const container = document.getElementById('chatbot-container');
            if (container) {
                container.innerHTML = chatbotHTML;
                const webhookUrl = 'https://n8n.automaita.it/webhook/ffausto-ai-chat';
                const bubble = document.getElementById('chatbot-bubble');
                const windowWrapper = document.getElementById('chatbot-window-wrapper');
                const messagesEl = document.getElementById('chatbot-messages');
                const inputField = document.getElementById('chatbot-input-field');
                const sendBtn = document.getElementById('chatbot-send-btn');
                const closeBtn = document.querySelector('.chatbot-close-btn');

                if (!bubble || !windowWrapper || !closeBtn) return;

                const toggleChat = () => {
                    const isChatOpen = windowWrapper.classList.contains('open');
                    if (isChatOpen) {
                        windowWrapper.classList.remove('open');
                        bubble.classList.remove('open');
                    } else {
                        windowWrapper.classList.add('open');
                        bubble.classList.add('open');
                        if (inputField) setTimeout(() => inputField.focus(), 350);
                    }
                };
                
                bubble.addEventListener('click', toggleChat);
                closeBtn.addEventListener('click', toggleChat);

                const addMessage = (text, type) => {
                    if (!messagesEl) return;
                    const msgDiv = document.createElement('div'); msgDiv.className = `message ${type}`;
                    if (type === 'bot') { const avatar = document.createElement('img'); avatar.src = 'fausto_immagine.jpg'; avatar.className = 'message-avatar'; msgDiv.appendChild(avatar); }
                    const textDiv = document.createElement('div'); textDiv.className = 'message-text';
                    textDiv.innerHTML = DOMPurify.sanitize(text);
                    msgDiv.appendChild(textDiv);
                    messagesEl.appendChild(msgDiv);
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                };

                const sendMessage = async () => {
                    if (!inputField) return;
                    const userMessage = inputField.value.trim(); if (userMessage === '') return;
                    addMessage(userMessage, 'user'); inputField.value = '';
                    try {
                        const response = await fetch(`${webhookUrl}?user_message=${encodeURIComponent(userMessage)}&conversation_id=session-${Date.now()}`, { method: 'POST' });
                        if (!response.ok) throw new Error("Network response");
                        const data = await response.json(); addMessage(data.response || "C'è stato un problema.", 'bot');
                    } catch (error) { addMessage('Spiacente, si è verificato un errore.', 'bot'); }
                };

                if (sendBtn && inputField) {
                    sendBtn.addEventListener('click', sendMessage);
                    inputField.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); } });
                }
                
                if (window.innerWidth > 768) {
                    setTimeout(() => { if (!windowWrapper.classList.contains('open')) { toggleChat(); } }, 1500);
                }
                addMessage("Ciao! Sono Fausto AI, il tuo assistente virtuale. Come posso aiutarti a trovare il brano perfetto per te?", 'bot');
            }
        });
    })();
  </script>
</body>
</html>
