<!DOCTYPE html>
<html lang="it">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KD9H9P2RKT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-KD9H9P2RKT');
</script>
<meta charset="UTF-8" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<link rel="preload" as="image" href="logo6.jpg">        
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Fausto Fusetti - FF Musica</title>
<link rel="icon" href="favicon.ico?v=2" sizes="any" type="image/x-icon">
<link rel="icon" href="icon-192.png?v=2" sizes="192x192" type="image/png">
<link rel="apple-touch-icon" href="apple-touch-icon.png?v=2">
<link href="https://fonts.googleapis.com/css2?family=Arvo:wght@700&amp;family=Montserrat:wght@400;500;600&amp;display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
<style>
/* CSS STYLES */
:root { --primary-color: #0693e3; --secondary-color: #e3a006; --jingle-color: #00e1ff; --text-gray: #aaa; }
* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }
body { font-family: 'Montserrat', sans-serif; color: #f0f0f0; text-align: center; }
#background-video { position: fixed; right: 0; bottom: 0; min-width: 100%; min-height: 100%; width: auto; height: auto; z-index: -100; object-fit: cover; filter: brightness(0.5); }
.container-wrapper { min-height: 100vh; width: 100%; display: flex; align-items: center; justify-content: center; padding: 20px; padding-bottom: 60px; }
.container { position: relative; background: rgba(0, 0, 0, 0.45); backdrop-filter: blur(10px); padding: 90px 30px 40px 30px; max-width: 680px; width: 100%; margin-top: 100px; margin-bottom: 40px; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1); z-index: 2; }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

/* PULSANTE AUDIO (POSIZIONAMENTO CORRETTO) */
#audio-cta { 
    position: absolute; top: -25px; right: -20px; 
    display: flex; align-items: center; 
    background-color: rgba(6, 147, 227, 0.2); 
    border: 1px solid var(--primary-color); 
    padding: 8px 15px; border-radius: 30px; 
    backdrop-filter: blur(5px); 
    animation: pulse 2.5s infinite ease-in-out; 
    z-index: 100; cursor: pointer; visibility: visible; 
}
#audio-cta .cta-text { margin-right: 10px; font-weight: 500; color: #f0f0f0; font-size: 0.9em; }
#mute-btn-icon { background: white; color: var(--primary-color); border-radius: 50%; width: 30px; height: 30px; font-size: 0.9em; display: flex; align-items: center; justify-content: center; }

@keyframes spin { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
.profile-logo { width: 150px; height: 150px; border-radius: 50%; border: 4px solid rgba(255, 255, 255, 0.9); box-shadow: 0 0 20px var(--primary-color); object-fit: cover; position: absolute; top: 0; left: 50%; transform: translate(-50%, -50%); animation: spin 15s linear infinite; }
h1 { font-size: 1.8em; margin-bottom: 15px; font-weight: 500; }
p.bio { font-size: 1.1em; margin-bottom: 25px; line-height: 1.7; color: #d1d1d1; }
.button { display: block; margin: 18px auto; padding: 16px 30px; border: 2px solid var(--primary-color); border-radius: 30px; text-decoration: none; color: #f0f0f0; font-size: 1.2em; font-weight: 500; transition: all 0.3s ease; background-color: transparent; cursor: pointer; }
.button:hover { background: var(--primary-color); color: white; transform: translateY(-3px); box-shadow: 0 4px 15px rgba(6, 147, 227, 0.4); }
.button.collabora { border-color: var(--secondary-color); } .button.collabora:hover { background: var(--secondary-color); box-shadow: 0 4px 15px rgba(227, 160, 6, 0.4); }
.button.jukebox { border-color: var(--secondary-color); } .button.jukebox:hover { background: var(--secondary-color); box-shadow: 0 4px 15px rgba(227, 160, 6, 0.4); }
.button.jingle { border-color: var(--jingle-color); color: var(--jingle-color); } 
.button.jingle:hover { background: var(--jingle-color); color: #000; box-shadow: 0 4px 20px rgba(0, 225, 255, 0.6); border-color: var(--jingle-color); }
.button i { margin-right: 10px; }
.social-icons { display: flex; justify-content: center; gap: 30px; margin: 40px 0 20px; }
.social-icons a { color: #c7c7c7; font-size: 2.2em; transition: all 0.3s ease; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 10000; padding: 20px; }
.modal-content { background: #1e1e1e; padding: 30px; border-radius: 15px; width: 100%; max-width: 650px; position: relative; max-height: 90vh; overflow-y: auto; }
.modal-close { position: absolute; top: 15px; right: 20px; font-size: 2em; color: white; cursor: pointer; line-height: 1; }
.music-catalog .info-box { background: rgba(6, 147, 227, 0.1); border: 1px solid var(--primary-color); padding: 15px; border-radius: 10px; margin-bottom: 25px; font-size: 1.1em; }

/* FILTRI E CONTROLLI */
.filter-group { margin-bottom: 15px; }
.filter-group .filter-label { text-align: left; margin-bottom: 8px; font-weight: 500; color: var(--primary-color); }
.filter-buttons { display: flex; flex-wrap: wrap; gap: 8px; }
.filter-btn { padding: 8px 14px; border: 1px solid #555; border-radius: 20px; background: none; color: #f0f0f0; cursor: pointer; font-size: 0.9em; transition: all 0.2s ease; }
.filter-btn.active { background: var(--primary-color); border-color: var(--primary-color); color: white; }

/* VIEW SWITCHER (LISTA vs ALBUM) */
.view-switcher { display: flex; justify-content: center; margin-bottom: 20px; gap: 10px; border-bottom: 1px solid #333; padding-bottom: 15px; }
.view-btn { background: transparent; border: 1px solid #555; color: #ccc; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: 0.3s; }
.view-btn.active { background: var(--primary-color); border-color: var(--primary-color); color: white; }
.view-btn:hover { border-color: var(--primary-color); }

/* LISTA BRANI */
.song-list-container { max-height: 50vh; overflow-y: auto; margin-top: 20px; }
.song-item { display: flex; align-items: center; padding: 12px 10px; border-bottom: 1px solid #333; transition: background-color 0.3s ease; border-radius: 5px; text-align: left; }
.song-item:last-child { border-bottom: none; }
.song-item:hover { background-color: rgba(255,255,255,0.05); }
.song-item.playing { background-color: rgba(6, 147, 227, 0.2); border-left: 3px solid var(--primary-color); }
.song-item.playing .play-btn { background-color: var(--primary-color); color: white; }

/* DETTAGLI BRANO */
.song-info { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; margin: 0 10px; }
.song-title { font-weight: 600; font-size: 1rem; color: #fff; margin-bottom: 4px; }
.song-meta { font-size: 0.8rem; color: var(--text-gray); display: flex; flex-wrap: wrap; gap: 10px; }
.song-meta span { display: flex; align-items: center; gap: 4px; }
.song-meta i { font-size: 0.75rem; color: var(--primary-color); }

/* PULSANTI PLAY/VIDEO */
.play-btn { background: none; border: 2px solid var(--primary-color); color: var(--primary-color); border-radius: 50%; width: 35px; height: 35px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; cursor: pointer; }
.video-btn { background: none; border: 2px solid var(--secondary-color); color: var(--secondary-color); border-radius: 50%; width: 35px; height: 35px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; margin-right: 8px; cursor: pointer; font-size: 0.8em; }
.video-btn:hover { background-color: var(--secondary-color); color: white; }

/* STILE ALBUM (ACCORDION) */
.album-card { background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 10px; margin-bottom: 15px; overflow: hidden; }
.album-header { padding: 15px; background: rgba(0,0,0,0.3); display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #444; cursor: pointer; transition: background 0.3s; }
.album-header:hover { background: rgba(255,255,255,0.08); }
.album-cover { width: 60px; height: 60px; border-radius: 5px; object-fit: cover; background: #222; border: 1px solid #555; }
.album-info { text-align: left; flex-grow: 1; }
.album-title { font-size: 1.2em; color: var(--primary-color); font-weight: bold; margin: 0; }
.album-count { font-size: 0.9em; color: #888; }
.album-toggle-icon { margin-left: auto; color: #888; transition: transform 0.3s; }
/* Nascosto di default */
.album-tracks { display: none; padding: 5px; border-top: 1px solid #444; background: rgba(0,0,0,0.1); }
/* Classe per aprire */
.album-card.open .album-tracks { display: block; }
.album-card.open .album-toggle-icon { transform: rotate(180deg); color: var(--primary-color); }

/* MODALI E ALTRO */
.contact-form { display: flex; flex-direction: column; gap: 15px; text-align: left; }
.contact-form input, .contact-form textarea, .contact-form select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #555; background-color: #2c2c2c; color: #f0f0f0; font-size: 1em; }
#form-result { margin-top: 15px; font-weight: bold; }
.service-highlight { background: linear-gradient(135deg, rgba(6, 147, 227, 0.1), rgba(227, 160, 6, 0.1)); border: 2px solid transparent; background-clip: padding-box; position: relative; }
.service-highlight::before { content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: inherit; z-index: -1; }
#aphorism-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; pointer-events: none; }
@keyframes fadeInOut { 0% { opacity: 0; transform: var(--transform-start); } 15% { opacity: 1; transform: var(--transform-end); } 85% { opacity: 1; transform: var(--transform-end); } 100% { opacity: 0; transform: var(--transform-start); } }
.aphorism-postit { position: absolute; background-color: #fefabc; color: #333; padding: 15px; border-radius: 5px; box-shadow: 5px 5px 15px rgba(0,0,0,0.3); max-width: 250px; font-family: 'Georgia', serif; animation: fadeInOut 10s ease-in-out forwards; }
#audio-start-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.9); display: flex; align-items: center; justify-content: center; z-index: 100000; backdrop-filter: blur(10px); }
#audio-start-content { background: rgba(6, 147, 227, 0.1); border: 2px solid var(--primary-color); padding: 40px; border-radius: 20px; text-align: center; max-width: 500px; margin: 20px; }
#audio-start-content h2 { color: var(--primary-color); margin-bottom: 15px; font-size: 1.8em; }
#audio-start-content p { margin-bottom: 25px; font-size: 1.1em; line-height: 1.6; }
#start-audio-btn { background: var(--primary-color); color: white; border: none; padding: 15px 30px; border-radius: 30px; font-size: 1.2em; cursor: pointer; transition: all 0.3s ease; }
#start-audio-btn:hover { background: var(--secondary-color); transform: translateY(-2px); }
.info-footer { position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(0, 0, 0, 0.85); color: #ccc; padding: 12px; text-align: center; font-size: 0.9em; z-index: 100; }
#single-video-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 20000; display: none; align-items: center; justify-content: center; flex-direction: column; }
#single-video-container { width: 90%; max-width: 900px; aspect-ratio: 16 / 9; position: relative; background: black; box-shadow: 0 0 30px rgba(6, 147, 227, 0.3); }
#single-video-container iframe { width: 100%; height: 100%; border: none; }
#close-single-video { margin-top: 20px; background: none; border: 1px solid white; color: white; padding: 10px 20px; border-radius: 30px; cursor: pointer; font-size: 1.2em; transition: all 0.3s; }
#close-single-video:hover { background: white; color: black; }
</style>
</head>
<body>

<!-- MUSICA BACKGROUND -->
<div id="audio-start-overlay">
    <div id="audio-start-content">
        <h2><i class="fas fa-music"></i> Benvenuto!</h2>
        <p>Per la migliore esperienza, questa pagina include una musica di sottofondo. Clicca per attivarla.</p>
        <button id="start-audio-btn">Avvia l'Esperienza Musicale</button>
    </div>
</div>
<video autoplay muted loop playsinline preload="auto" id="background-video" poster="immagine_sfondo.png"><source src="video_sfondo_compressed.mp4" type="video/mp4" /></video>
<audio loop preload="auto" id="background-audio"><source src="7a-Controtempo-compresso.mp3" type="audio/mpeg" /></audio>

<!-- CONTENITORE PRINCIPALE -->
<div class="container-wrapper">
    <div class="container">
        <!-- PULSANTE AUDIO RIPRISTINATO -->
        <div id="audio-cta"><span class="cta-text">Attiva musica</span><div id="mute-btn-icon"><i class="fas fa-volume-mute"></i></div></div>
        
        <img src="logo6.jpg" alt="Logo FF Musica" class="profile-logo">
        <br><br><br><br>
        <h1>Fausto Fusetti</h1>
        <p class="bio">Piacere, sono Fausto Fusetti, in arte <strong>Fausto Miriani</strong>. Dal 1988 la musica è la mia vita: sono polistrumentista, cantante, compositore, paroliere e anche autore di libri.<br><br>La mia carriera è stata un viaggio entusiasmante sui palchi più prestigiosi, collaborando con icone come <strong>Fred Bongusto, Peppino di Capri e Califano</strong>.<br><br>Oggi metto questa esperienza al tuo servizio per creare <strong>canzoni e libri personalizzati</strong>, e continuo a investire sul futuro.</p>

        <!-- MENU PULSANTI -->
        <a href="https://rickym2025.github.io/jukebox-ff/" target="_blank" class="button jukebox"><i class="fas fa-compact-disc"></i> Area Riservata Jukebox</a>
        <a href="https://rickym2025.github.io/JingleShop/" target="_blank" class="button jingle"><i class="fas fa-icons"></i> Jingle Shop & Royalty Free</a>
        <button id="open-music-modal" class="button"><i class="fas fa-music"></i> Catalogo Musicale</button>
        <button id="open-video-modal" class="button"><i class="fas fa-video"></i> Guarda i Video</button>
        <button id="open-services-modal" class="button service-highlight"><i class="fas fa-heart"></i> Canzoni Personalizzate</button>
        <button id="open-contact-modal" class="button collabora"><i class="fas fa-pencil-alt"></i> Contattami per un Progetto</button>
        <button id="open-shop-modal" class="button"><i class="fas fa-shopping-cart"></i> Shop</button>
        <a href="blog/index.html" class="button" style="border-color: #fff; color: #fff;"><i class="fas fa-newspaper"></i> Blog & News</a>  

        <div class="social-icons">
            <a href="https://www.instagram.com/faustofusetti/" target="_blank"><i class="fa-brands fa-instagram"></i></a>
            <a href="https://www.facebook.com/fausto.fusetti.9" target="_blank"><i class="fa-brands fa-facebook"></i></a>
            <a href="https://www.youtube.com/@faustofusetti5859" target="_blank"><i class="fa-brands fa-youtube"></i></a>
        </div>
    </div>
</div>

<!-- MODALE CATALOGO -->
<div id="music-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content music-catalog">
        <span class="modal-close">&times;</span>
        <h2>Catalogo Musicale</h2>
        <div class="info-box"><i class="fas fa-headphones"></i> Esplora la discografia di Fausto.</div>
        
        <!-- SWITCHER VISTA -->
        <div class="view-switcher">
            <button class="view-btn active" id="btn-album-view" onclick="switchView('album')"><i class="fas fa-compact-disc"></i> Album</button>
            <button class="view-btn" id="btn-list-view" onclick="switchView('list')"><i class="fas fa-list"></i> Lista</button>
        </div>

        <div id="filter-container"></div>
        <div id="song-list-container"></div>
        <audio id="catalog-audio-player"></audio>
    </div>
</div>

<!-- ALTRE MODALI -->
<div id="shop-modal" class="modal-overlay" style="display:none;"><div class="modal-content"><span class="modal-close">&times;</span><h2><i class="fas fa-shopping-cart"></i> Shop / Supportami</h2><p>Acquista la mia attrezzatura o il merchandising ufficiale.</p><a href="https://www.amazon.it/hz/wishlist/ls/282CA0XU81D3C" target="_blank" class="button">La mia Attrezzatura</a><a href="https://ff-music-store.printify.me/" target="_blank" class="button">Merchandising Ufficiale</a></div></div>
<div id="video-modal" class="modal-overlay" style="display:none;"><div class="modal-content"><span class="modal-close">&times;</span><h2>Video Selezionati</h2><a href="https://www.youtube.com/watch?v=7s3-7DV38IA" target="_blank" class="button">Produzioni Varie</a><a href="https://www.youtube.com/watch?v=Y8YqyCT7h5E" target="_blank" class="button">Ascolta "Noi"</a></div></div>
<div id="services-modal" class="modal-overlay" style="display:none;"><div class="modal-content"><span class="modal-close">&times;</span><h2>Canzoni Personalizzate</h2><p>Regala un'emozione unica con una canzone scritta su misura.</p><button id="contact-for-custom-song" class="button collabora">Richiedi Info</button></div></div>
<div id="contact-modal" class="modal-overlay" style="display:none;"><div class="modal-content"><span class="modal-close">&times;</span><h2>Contattami</h2><form id="contact-form" class="contact-form"><input type="hidden" name="access_key" value="9013a8d5-0901-42a0-b9e6-4c45553f960d"><input type="text" name="name" placeholder="Nome" required><input type="email" name="email" placeholder="Email" required><textarea name="message" rows="4" placeholder="Messaggio" required></textarea><button type="submit" class="button collabora">Invia</button></form><div id="form-result"></div></div></div>

<!-- VIDEO PLAYER OVERLAY -->
<div id="single-video-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:20000; align-items:center; justify-content:center; flex-direction:column;">
    <div id="single-video-container" style="width:90%; max-width:900px; aspect-ratio:16/9; background:black;"></div>
    <button id="close-single-video" style="margin-top:20px; background:none; border:1px solid white; color:white; padding:10px 20px; border-radius:30px; cursor:pointer;">Chiudi Video</button>
</div>

<div class="info-footer">Iscrizione SIAE n. 189515 e 593874</div>
<div id="chatbot-container"></div>

<!-- SCRIPTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {

    // === AGGIORNA QUI SOTTO CON IL TUO NUOVO URL DI APPS SCRIPT ===
    // (Devi fare: Gestisci Deployment > Matita > Nuova Versione > Deployment)
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyyvfsSlgx6J-dIeLaIi3Crd6eqG029DDsGzF3Wy8u1VIfwhTMDZJdTPS_ubYszUyFR/exec'; 
    
    // WEBHOOK N8N
    const CHATBOT_WEBHOOK = 'https://n8n.labottegadeldelta.it/webhook/ffausto-ai-chat';

    const appState = {
        allSongs: [],
        currentFilters: { category: 'all', argomento: 'all' },
        viewMode: 'album',
        currentPlayingItem: null,
        isBgMusicMuted: true
    };

    // ELEMENTI DOM
    const mainPlayer = document.getElementById('catalog-audio-player');
    const songListContainer = document.getElementById('song-list-container');
    const filterContainer = document.getElementById('filter-container');
    const bgAudio = document.getElementById('background-audio');

    // --- SETUP INIZIALE ---
    function init() {
        setupModals();
        setupAudio();
        setupVideoOverlay();
        loadMusicFromApi(); // Carica catalogo
        setupChatbot();     // Avvia Chatbot
    }

    // --- MODALI ---
    function setupModals() {
        const openModal = (id) => {
            mainPlayer.pause();
            document.getElementById(id).style.display = 'flex';
        };
        const closeModal = (id) => {
            document.getElementById(id).style.display = 'none';
            // Riprendi musica background solo se era attiva e non mutata
            if(!appState.isBgMusicMuted && bgAudio && bgAudio.paused) bgAudio.play().catch(()=>{});
        };

        document.getElementById('open-music-modal').onclick = () => openModal('music-modal');
        document.getElementById('open-video-modal').onclick = () => openModal('video-modal');
        document.getElementById('open-services-modal').onclick = () => openModal('services-modal');
        document.getElementById('open-contact-modal').onclick = () => openModal('contact-modal');
        document.getElementById('open-shop-modal').onclick = () => openModal('shop-modal');
        document.getElementById('contact-for-custom-song').onclick = () => { closeModal('services-modal'); openModal('contact-modal'); };
        
        document.querySelectorAll('.modal-close').forEach(btn => 
            btn.onclick = (e) => closeModal(e.target.closest('.modal-overlay').id)
        );
    }

    // --- AUDIO SOTTOFONDO ---
    function setupAudio() {
        const overlay = document.getElementById('audio-start-overlay');
        const btn = document.getElementById('start-audio-btn');
        const cta = document.getElementById('audio-cta');

        btn.onclick = () => {
            overlay.style.display = 'none';
            appState.isBgMusicMuted = false;
            bgAudio.volume = 0.5;
            bgAudio.play().catch(e => console.log("Autoplay bloccato", e));
            updateMuteIcon();
        };

        cta.onclick = () => {
            appState.isBgMusicMuted = !appState.isBgMusicMuted;
            if(appState.isBgMusicMuted) { bgAudio.pause(); mainPlayer.pause(); }
            else { bgAudio.play(); }
            updateMuteIcon();
        };
    }

    function updateMuteIcon() {
        const icon = document.querySelector('#mute-btn-icon i');
        const text = document.querySelector('.cta-text');
        if(appState.isBgMusicMuted) {
            icon.className = 'fas fa-volume-mute';
            text.textContent = 'Attiva Musica';
        } else {
            icon.className = 'fas fa-volume-up';
            text.textContent = 'Disattiva';
        }
    }

    // --- CARICAMENTO DATI ---
    async function loadMusicFromApi() {
        // Usa timestamp per evitare cache browser
        const scriptUrl = `${GOOGLE_SCRIPT_URL}?source=catalogo&t=${Date.now()}`;
        
        songListContainer.innerHTML = '<p style="color:#aaa"><i class="fas fa-spinner fa-spin"></i> Caricamento...</p>';
        
        try {
            const res = await fetch(scriptUrl);
            if (!res.ok) throw new Error("Errore di rete. Controlla deployment script.");
            const data = await res.json();
            
            if(data.status === 'error') throw new Error(data.message);
            
            if(Array.isArray(data)) {
                appState.allSongs = data;
                renderCatalog();
            } else {
                throw new Error("Formato dati non valido");
            }
        } catch(e) {
            console.error(e);
            songListContainer.innerHTML = `<p style='color:#ff5555'>Errore catalogo: ${e.message}<br>Aggiorna il deployment dello script Google.</p>`;
        }
    }

    // --- RENDERIZZAZIONE ---
    window.switchView = function(mode) {
        appState.viewMode = mode;
        document.getElementById('btn-list-view').classList.toggle('active', mode === 'list');
        document.getElementById('btn-album-view').classList.toggle('active', mode === 'album');
        renderCatalog(); 
    };

    function renderCatalog() {
        createFilterButtons();

        // Filtra i brani
        const filtered = appState.allSongs.filter(s => {
            const get = (k) => { 
                const key = Object.keys(s).find(x => x.toLowerCase() === k.toLowerCase());
                return key ? s[key] : "";
            };
            const cat = get('Categoria');
            const arg = get('Argomento');
            
            const matchCat = appState.currentFilters.category === 'all' || (cat && cat.includes(appState.currentFilters.category));
            const matchArg = appState.currentFilters.argomento === 'all' || (arg && arg.includes(appState.currentFilters.argomento));
            return matchCat && matchArg;
        });

        songListContainer.innerHTML = '';
        if(filtered.length === 0) {
            songListContainer.innerHTML = '<p>Nessun brano trovato.</p>';
            return;
        }

        if(appState.viewMode === 'list') {
            filtered.forEach(song => songListContainer.appendChild(createSongRow(song)));
        } else {
            // VISTA ALBUM
            const albums = {};
            filtered.forEach(song => {
                const get = (k) => { const key = Object.keys(song).find(x => x.toLowerCase() === k.toLowerCase()); return key ? song[key] : ""; };
                let alb = get('Titolo_CD') || "Singoli & Altro";
                if(!albums[alb]) albums[alb] = [];
                albums[alb].push(song);
            });

            for(const [name, songs] of Object.entries(albums)) {
                const getFirst = (k) => { const key = Object.keys(songs[0]).find(x => x.toLowerCase() === k.toLowerCase()); return key ? songs[0][key] : ""; };
                const cover = getFirst('Link_Thumbnail') || 'logo6.jpg';

                const card = document.createElement('div');
                card.className = 'album-card';
                card.innerHTML = `
                    <div class="album-header" onclick="this.parentElement.classList.toggle('open')">
                        <img src="${cover}" class="album-cover" onerror="this.src='logo6.jpg'">
                        <div class="album-info">
                            <h3 class="album-title">${name}</h3>
                            <span class="album-count">${songs.length} brani</span>
                        </div>
                        <i class="fas fa-chevron-down album-toggle-icon"></i>
                    </div>
                    <div class="album-tracks"></div>
                `;
                
                const trackContainer = card.querySelector('.album-tracks');
                songs.forEach(s => trackContainer.appendChild(createSongRow(s)));
                songListContainer.appendChild(card);
            }
        }
    }

    function createSongRow(song) {
        const get = (k) => { const key = Object.keys(song).find(x => x.toLowerCase() === k.toLowerCase()); return key ? song[key] : ""; };
        
        const div = document.createElement('div');
        div.className = 'song-item';
        
        let vidBtn = '';
        const vidLink = get('Video_Link');
        if(vidLink) {
            vidBtn = `<div class="video-btn" onclick="openVideo('${vidLink}', event)"><i class="fas fa-video"></i></div>`;
        }

        div.innerHTML = `
            <div class="song-info">
                <span class="song-title">${get('Titolo') || 'Senza Titolo'}</span>
                <div class="song-meta">
                    ${get('Categoria') ? `<span><i class="fas fa-music"></i> ${get('Categoria')}</span>` : ''}
                    ${get('Durata') ? `<span><i class="far fa-clock"></i> ${get('Durata')}</span>` : ''}
                </div>
            </div>
            ${vidBtn}
            <div class="play-btn" onclick="playSong('${get('url')}', '${get('Titolo')}', this)"><i class="fas fa-play"></i></div>
        `;
        return div;
    }

    // --- FILTRI ---
    function createFilterButtons() {
        const extract = (keyName) => {
            const raw = appState.allSongs.map(s => {
                const key = Object.keys(s).find(k => k.toLowerCase() === keyName.toLowerCase());
                return key ? s[key] : "";
            }).filter(Boolean);
            // Filtra stringhe vuote
            return [...new Set(raw.flatMap(t => t.split(/[;,]+/).map(x => x.trim()).filter(x => x && x !== "")))].sort();
        };

        const cats = extract('Categoria');
        const args = extract('Argomento');

        let html = '';
        html += renderFilterGroup('Genere', 'category', cats);
        html += renderFilterGroup('Mood', 'argomento', args);
        filterContainer.innerHTML = html;
    }

    function renderFilterGroup(label, type, values) {
        let h = `<div class="filter-group"><div class="filter-label">${label}</div><div class="filter-buttons">`;
        h += `<button class="filter-btn active" onclick="applyFilter('${type}', 'all', this)">Tutti</button>`;
        values.forEach(v => h += `<button class="filter-btn" onclick="applyFilter('${type}', '${v}', this)">${v}</button>`);
        h += `</div></div>`;
        return h;
    }

    window.applyFilter = function(type, val, btn) {
        appState.currentFilters[type] = val;
        btn.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderCatalog();
    };

    // --- PLAYER & TRACKING ---
    window.playSong = function(url, title, btn) {
        if(appState.currentPlayingItem) appState.currentPlayingItem.classList.remove('playing');
        const row = btn.closest('.song-item');
        row.classList.add('playing');
        appState.currentPlayingItem = row;
        mainPlayer.src = url;
        mainPlayer.play();

        // Invio Tracking
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', 
            body: JSON.stringify({ action: 'increment', title: title })
        }).catch(e => console.log("Tracking error", e));
    };

    window.openVideo = function(url, e) {
        e.stopPropagation();
        mainPlayer.pause();
        const overlay = document.getElementById('single-video-overlay');
        const container = document.getElementById('single-video-container');
        container.innerHTML = `<video controls autoplay style="width:100%; height:100%"><source src="${url}" type="video/mp4"></video>`;
        overlay.style.display = 'flex';
    };

    function setupVideoOverlay() {
        document.getElementById('close-single-video').onclick = () => {
            document.getElementById('single-video-overlay').style.display = 'none';
            document.getElementById('single-video-container').innerHTML = '';
        };
    }

    // --- CHATBOT ORIGINALE ---
    function setupChatbot() {
        const c = document.getElementById('chatbot-container');
        c.innerHTML = `
            <style>
                #chatbot-bubble { position:fixed; bottom:25px; right:25px; width:65px; height:65px; border-radius:50%; box-shadow:0 4px 12px rgba(0,0,0,0.3); cursor:pointer; background-image:url(fausto_immagine.jpg); background-size:cover; background-position:center; border:3px solid var(--primary-color); z-index:9999; transition:transform 0.3s; }
                #chatbot-bubble:hover { transform:scale(1.1); }
                #chatbot-window-wrapper { position:fixed; bottom:100px; right:25px; width:350px; height:500px; background:white; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.3); z-index:9999; display:flex; flex-direction:column; overflow:hidden; }
                #chatbot-window { display:flex; flex-direction:column; height:100%; }
                .chatbot-header { background:var(--primary-color); color:white; padding:15px; text-align:center; font-weight:bold; position:relative; }
                .chatbot-header-logo { width:60px; height:60px; border-radius:50%; border:3px solid white; position:absolute; top:40px; left:50%; transform:translateX(-50%); box-shadow:0 2px 5px rgba(0,0,0,0.2); object-fit:cover; }
                .chatbot-messages { flex-grow:1; padding:15px; padding-top:40px; overflow-y:auto; background:#f9f9f9; color:#333; text-align:left; }
                .chatbot-input { border-top:1px solid #ddd; padding:10px; display:flex; background:white; }
                .chatbot-input input { flex-grow:1; border:none; padding:10px; outline:none; font-size:1rem; }
                .chatbot-input button { background:none; border:none; color:var(--primary-color); padding:0 10px; cursor:pointer; }
                .msg { margin-bottom:10px; padding:8px 12px; border-radius:15px; max-width:80%; font-size:0.9em; word-wrap: break-word; }
                .msg.bot { background:rgba(6, 147, 227, 0.1); border:1px solid #ddd; align-self:flex-start; margin-right:auto; }
                .msg.user { background:var(--primary-color); color:white; align-self:flex-end; margin-left:auto; }
                .chatbot-song-link { display:block; color:var(--primary-color); text-decoration:none; margin:5px 0; border-bottom:1px dashed #ccc; }
            </style>
            
            <div id="chatbot-bubble" onclick="toggleChat()"></div>
            <div id="chatbot-window-wrapper" style="display:none">
                <div id="chatbot-window">
                    <div class="chatbot-header">
                        Fausto AI
                        <span onclick="toggleChat()" style="float:right; cursor:pointer; font-size:1.5em;">&times;</span>
                    </div>
                    <img src="fausto_immagine.jpg" class="chatbot-header-logo">
                    <div id="chatbot-messages" class="chatbot-messages"></div>
                    <div class="chatbot-input">
                        <input type="text" id="chat-input" placeholder="Scrivi qui..." onkeypress="if(event.key==='Enter') sendMsg()">
                        <button onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        `;

        setTimeout(() => {
            addMsg("Ciao! Sono l'assistente virtuale. Posso aiutarti a trovare una canzone?", 'bot');
        }, 1000);
    }

    window.toggleChat = function() {
        const w = document.getElementById('chatbot-window-wrapper');
        w.style.display = w.style.display === 'none' ? 'flex' : 'none';
    };

    window.addMsg = function(text, sender) {
        const div = document.createElement('div');
        div.className = `msg ${sender}`;
        div.innerHTML = text; 
        const c = document.getElementById('chatbot-messages');
        c.appendChild(div);
        c.scrollTop = c.scrollHeight;
        
        if(sender === 'bot') {
            div.querySelectorAll('.chatbot-song-link').forEach(link => {
                link.onclick = (e) => {
                    e.preventDefault();
                    playSong(link.dataset.src, link.innerText, document.body);
                };
            });
        }
    };

    window.sendMsg = async function() {
        const input = document.getElementById('chat-input');
        const text = input.value;
        if(!text.trim()) return;
        
        input.value = '';
        addMsg(text, 'user');

        try {
            const res = await fetch(`${CHATBOT_WEBHOOK}?user_message=${encodeURIComponent(text)}`, { method:'POST' });
            const data = await res.json();
            addMsg(data.response, 'bot');
        } catch(e) {
            addMsg("Errore di connessione.", 'bot');
        }
    };

    init();
});
</script>
</body>
</html>
